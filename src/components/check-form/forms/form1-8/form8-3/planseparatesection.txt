

[แผนสรุปใหม่ (อิงไฟล์อ้างอิง + ชื่อไฟล์ใหม่แบบเลขหัวข้อ)]
ไฟล์อ้างอิงค์คือ F:\APCoding\Shinaracha\src\components\check-form\forms\form1-8\form8-1\Form8_1.tsx.bak-25681119-145122
กติกาการตั้งชื่อ (เอาข้อความออก เหลือเลขหัวข้อให้ชัดเจน)
- 1.x รายงานผลการตรวจสอบป้าย:
  - Form8_3_Report_1_0.tsx
  - Form8_3_Report_1_1.tsx
  - Form8_3_Report_1_2.tsx
  - Form8_3_Report_1_3.tsx
  - Form8_3_Report_1_4.tsx
- 2.x แผนปฏิบัติการตรวจบำรุงรักษาป้ายฯ:
  - Form8_3_Plan_2_1.tsx … Form8_3_Plan_2_7.tsx

[x] เฟส A: Rename + ปรับ Orchestrator ให้ตรงไฟล์อ้างอิง
    [ ] เปลี่ยนชื่อไฟล์ 1.x เป็น Form8_3_Report_1_0 … 1_4
    [ ] เปลี่ยนชื่อไฟล์ 2.x เป็น Form8_3_Plan_2_1 … 2_7
    [ ] Orchestrator: เมนู 1.x เรนเดอร์เฉพาะ 1.0–1.4, เมนู 2.x เรนเดอร์ 2.1–2.7 ตามลำดับเดิม
    [ ] Section ID ใช้คีย์ตามไฟล์อ้างอิง (เช่น r_cover/r_info/r_scope, plan_2_x)

[ ] เฟส B: ย้าย JSX จริงให้ “เหมือนต้นฉบับ” (หมวด 1.x)
    [ ] 1.0 → Form8_3_Report_1_0.tsx (รวม r_cover + r_info ตามไฟล์อ้างอิง)
    [ ] 1.1 → Form8_3_Report_1_1.tsx (ขอบเขตการตรวจ r_scope)
    [ ] 1.2 → Form8_3_Report_1_2.tsx (ประเภทการติดตั้ง/ผู้เกี่ยวข้อง + "อื่น ๆ (ระบุ)" inline)
    [x] 1.3 → Form8_3_Report_1_3.tsx (วัสดุ/โครงสร้าง + ฟิลด์ผิววัสดุ/ช่องเปิด/หมายเหตุ)
    [x] 1.4 → Form8_3_Report_1_4.tsx (พิกัด + แผนที่/ผัง + พรีวิว + revoke URL)

[ ] เฟส C: ย้าย/จัด 2.x ให้ตรงไฟล์อ้างอิง
    [ ] 2.1 → Form8_3_Plan_2_1.tsx (read‑only ข้อความตามไฟล์อ้างอิง)
    [ ] 2.2 → Form8_3_Plan_2_2.tsx (read‑only)
    [ ] 2.3 → Form8_3_Plan_2_3.tsx (read‑only)
    [ ] 2.4 → Form8_3_Plan_2_4.tsx (read‑only)
    [ ] 2.5 → Form8_3_Plan_2_5.tsx (ตาราง thead+colspan, กลุ่ม โครงสร้าง/ระบบร่วม, รองรับ "อื่น ๆ (ระบุ)")
    [ ] 2.6 → Form8_3_Plan_2_6.tsx (ตารางผลการตรวจ: not_found/found/fixed + หมายเหตุ + "อื่น ๆ (ระบุ)")
    [ ] 2.7 → Form8_3_Plan_2_7.tsx (สรุปรวม + ผู้ลงนาม/(ชื่อพิมพ์)/วันที่)

[ ] เฟส D: สเตต/พฤติกรรม
    [ ] Orchestrator คุม state รวม Form8_1Data
    [ ] onChange(patch) per section + deep‑merge เฉพาะจุด (owner/designer, coordinate, inspect.items, plan.frequencyPlan/resultsPlan/summaryPlan)
    [ ] อ่าน/บันทึกเดิมผ่าน /api/auth/forms/get|post (entity:function form8_1)

[ ] เฟส E: ตรวจคุณภาพ/ส่งมอบ (ต้องได้รับอนุญาตก่อนทุกคำสั่ง)
    [ ] npx tsc --noEmit (TS/JSX)
    [ ] npm run build (Next.js build)
    [ ] docker compose build/up (service app)
    [ ] Health check: /api/health → 200
    [ ] UI ตรวจด้วยตา 360/768/1280 ว่าตรงต้นฉบับ

หมายเหตุ
- ยึดข้อความ/DOM/className/ลำดับ/ตาราง “เหมือนไฟล์อ้างอิง” ทุกจุด
- ไม่เปลี่ยนพฤติกรรม upload/save/state ที่ไม่เกี่ยวข้อง
- อัปเดตเช็กลิสต์และบันทึก Log (pond_Log_GPT_Edit.text) ทุกครั้งที่งานเสร็จหนึ่งข้อ




[อัปเดตเฟส B - 2568-11-19 22:59:02]
[x] 1.0 (ส่วนหัว/ภาพหลัก) เสร็จ
[ ] 1.1 (ขอบเขตงาน) รออัปเดตข้อความตามไฟล์ .bak
[x] 1.2 (ข้อมูลทั่วไป + แผนที่/ผัง) เสร็จ
[x] 1.3 (รายละเอียดตรวจ 7 ข้อ) เสร็จ
[x] 1.4 (สรุปผล + ลงนาม) เสร็จ

[x] 1.1 (ขอบเขตงาน) อัปเดตตาม .bak เรียบร้อย

[x] 2.1 (ขอบเขตงาน) อัปเดตแล้ว
[x] 2.2 (คำอธิบายแผน) อัปเดตแล้ว
[x] 2.3 (รายละเอียด) อัปเดตแล้ว
[x] 2.4 (แนวทาง/มาตรฐาน) อัปเดตแล้ว
[x] 2.5 (ตารางความถี่ thead/colspan) อัปเดตแล้ว
[x] 2.6 (ผลการตรวจ radio thead/colspan) อัปเดตแล้ว
[x] 2.7 (สรุป/ลงนาม + ตาราง) อัปเดตแล้ว

[อัปเดต] ตรวจยืนยัน 1.0, 1.2–1.4 ตรงตาม .bak แล้ว

[x] เติมข้อความ read-only 2.1–2.4 จาก .bak เรียบร้อย

[x] ปรับชื่อ Section + CSS ตารางแนวตั้ง ให้ตรง .bak

[x] ปรับชื่อหัวข้อเป็น 'ส่วนที่ N' ครบ 1.1–1.4 และ 2.1–2.7

[x] เพิ่มเมนูพับใหญ่ 1) และ 2) ครอบ 1.x/2.x ตาม .bak

[x] ตั้งค่าเริ่มต้นเมนูพับใหญ่/ย่อยให้ปิดทั้งหมด

[x] แก้ 1.0 (ข้อความไทย), [x] อัปเดต section3Content ไทย, [x] ล็อกหัวข้อคงที่ใน 2.7

---------------------------------------------
[แผนสไตล์ UI ให้ตรง Form1_3 (ยังไม่ลงมือ)]
แนวทางรวม
- เป้าหมาย: ให้ 2.6/2.7 (และส่วนที่เกี่ยว) ใช้สไตล์ radio และหมายเหตุแบบเดียวกับ Form1_3/SectionFourDetails.tsx
- ส่วนประกอบที่ดึงมาใช้ซ้ำ:
  • CheckTick (ปุ่มสี่เหลี่ยมแสดง ✓ พื้นแดงเมื่อเลือก)
  • RemarkCell (ข้อความ/placeholder + ปุ่มดินสอเปิด modal แก้ไข)
- โฟลเดอร์ใหม่: src/components/check-form/common/
  • CheckTick.tsx, RemarkCell.tsx, NoteModal.tsx
- ไม่แตะ logic บันทึก/โหลดเดิม ยกเว้นเปลี่ยน event ให้ส่ง patch ตามคีย์ใหม่

แผนย่อยตามหัวข้อ (1.0–2.7)
    [ ] 1.0 Header: ไม่เปลี่ยน (ตรวจ spacing/สีหัวข้อให้ตรง Form1_3)
    [ ] 1.1–1.4: ตรวจเฉพาะคอลัมน์หมายเหตุ (ถ้ามี) ให้ใช้ RemarkCell เดียวกัน
    [ ] 2.1–2.4: ไม่มี input (read-only) — ปรับระยะขอบ/ฟอนต์เท่ากัน
    [x] 2.5: ถ้าต้องมีหมายเหตุรายแถว ให้เปลี่ยนเป็น RemarkCell; radio ความถี่คงเดิม (กลม) แต่ใช้สี/ขนาดเทียบ Form1_3
    [x] 2.6: เปลี่ยน radio “ใช้ได้/ใช้ไม่ได้” เป็น CheckTick 2 ปุ่ม (exclusive ต่อแถว), คอลัมน์หมายเหตุใช้ RemarkCell, คงหัว 2 ชั้น “รอบที่ 1”
    [x] 2.7: radio “ใช้ได้/ใช้ไม่ได้” เป็น CheckTick เช่นกัน + คอลัมน์ “แก้ไขแล้ว” เป็น checkbox สี่เหลี่ยม, หมายเหตุใช้ RemarkCell, คง auto-assign จาก 2.6 ตามที่กำหนดไว้

รายการงานละเอียด
    [ ] สร้าง common/CheckTick.tsx: props { checked:boolean; onChange:()=>void; disabled?:boolean; size?:'sm'|'md' } สไตล์อ้างอิง Form1_3
    [ ] สร้าง common/NoteModal.tsx: modal กลางจอ + textarea + ปุ่ม ยกเลิก/บันทึก
    [ ] สร้าง common/RemarkCell.tsx: แสดงข้อความ/placeholder เทา + IconButton ดินสอ -> เปิด NoteModal และ onSave(note)
    [ ] ผนวก RemarkCell ใน 2.6/2.7 แทน input เดิม (ไม่เปลี่ยน key: note)
    [ ] ปรับ 2.6 แถว: ลำดับ | รายการตรวจสอบ | รอบที่ 1(ใช้ได้/ใช้ไม่ได้) | หมายเหตุ (CheckTick 2 ปุ่มแทน radio)
    [ ] ปรับ 2.7 แถว: รายการ | รอบที่ 1(ใช้ได้/ใช้ไม่ได้) | แก้ไขแล้ว(checkbox) | หมายเหตุ (CheckTick + RemarkCell)
    [ ] ปรับสี/spacing ตารางให้สอดคล้อง: border-gray-300, thead bg-gray-100, odd:bg-white even:bg-gray-50
    [ ] สอดคล้อง mobile: คงตารางแนวนอน + overflow-x-auto

ตรวจสอบ/ยืนยัน (หลังได้รับอนุญาตค่อยทำ)
    [ ] npx tsc --noEmit
    [ ] npm run build
    [ ] ตรวจ UI 360/768/1280 ว่า CheckTick/RemarkCell ทำงานและ modal แสดง/บันทึกได้

---------------------------------------------
[Checklist: เฟส 1–2 ปรับคีย์/ชนิดให้ตรง UI]
    [x] types.ts: เพิ่ม UsabilityStatus/UsabilityRow/PlanUsability, เปลี่ยน FrequencyRow.freq→frequency
    [x] types.ts: Form8_1Plan ใช้คีย์ใหม่ (scopeOfWork, planDescription, inspectionDetails, guidelineStandard, usabilityPlan, frequencyText/usabilityText/summaryText)
    [x] types.ts: defaultForm8_1.plan ใช้คีย์ใหม่ (scopeOfWork/planDescription/...)
    [x] Form8_1.tsx: เพิ่ม normalizePlan()/normalizeData() map คีย์เก่า→ใหม่ และ map status not_found/found → usable/unusable
    [x] Form8_1.tsx: ปรับ setPlan รองรับ usabilityPlan (รับ resultsPlan ตกทอดได้)
    [x] Form8_3_Plan_2_5.tsx: ใช้ field row.frequency (แทน freq)
    [x] Form8_3_Plan_2_6.tsx: ใช้ UsabilityStatus 'usable'|'unusable' + thead รอบที่ 1/ใช้ได้/ใช้ไม่ได้ + เพิ่มคอลัมน์ลำดับ
    [x] Form8_3_Plan_2_7.tsx: ใช้ UsabilityStatus + auto assign จาก 2.6 ต่อหมวด + checkbox 'แก้ไขแล้ว' แยกอิสระ
    [ ] รัน npx tsc --noEmit ตรวจ TS
    [x] รัน npm run build ตรวจ build


[Checklist: Rename จริง 1.0–1.4 ให้ตรง UI]
    [x] 1.0 types.ts (report): headerLine2→legalBasisLine1, headerLine3→legalBasisLine2, mainImageUrl→headerImageUrl, mainDetail→headerNote, address→companyAddress, scopeNote→inspectionScopeNote
    [x] 1.0 Form8_3_Report_1_0.tsx: เปลี่ยนคีย์ที่ใช้ในฟอร์มและพรีวิวภาพหลักให้เป็นชื่อใหม่
    [x] 1.1 Form8_3_Report_1_1.tsx: scopeNote→inspectionScopeNote
    [x] 1.2 types.ts (general/location/photos):
        - permitDocAvailable→hasPermitDocument, noPermitInfo→permitInfoUnknown, exemptPermit→permitExempt
        - missingPlan→missingOriginalPlan, ageApproxBuddhistYear→approxBuddhistYear, phone→phoneNo
        - size.structureHeight→signStructureHeight
        - location.mapImage→mapImageFilename, layoutImage→layoutImageFilename
        - photos: hero→coverPhoto, signMain→signMainPhoto, setA→setAPhotos, setB→setBPhotos
    [x] 1.2 Form8_3_Report_1_2.tsx: mapImage/layoutImage/phone/missingPlan/exemptPermit และอื่น ๆ ให้ตรงชื่อใหม่
    [x] 1.3 การ์ด: details→changeDetailNote, opinion→inspectorOpinion (ใน Form8_3_Report_1_3.tsx)
    [x] 1.3 ตาราง: opinion→inspectorOpinion, remark→note (ใน Main1_Inspect.tsx)
    [x] 1.4 สรุปผล: summary.rows[].remark→note, signoff: conclusion→overallConclusion, inspectedAt→inspectionDate, ownerName→ownerOrRepresentative, signatureName→signature, minorNote→minorRemark, fixIssue→fixIssueSubject (ใน types/และ Form8_3_Report_1_4.tsx)
    [x] Orchestrator Form8_1.tsx: ensureSummaryRows ใช้ note (แทน remark) และส่ง props ให้คอมโพเนนต์ตามคีย์ใหม่
    [x] รัน npm run build ตรวจสอบว่า build ผ่าน → ติ๊กทุกข้อที่เสร็จ


[Checklist: Fix cursor focus 1.x / 2.x — 2568-11-20]
เป้าหมาย: พิมพ์ได้ต่อเนื่องไม่หลุดโฟกัส ลด re-mount และ re-render กว้าง ระหว่างใช้งานและอัปโหลดรูป

Core mitigation (ทุกส่วน)
- [x] ตัด window.alert ระหว่างใช้งาน เปลี่ยนเป็น inline status/toast (ทำแล้วใน 1.2)
- [x] คง main-1/main-2 ให้ mounted ตลอด (ซ่อนด้วย CSS grid)
- [x] ทำ setter ของ Orchestrator ให้เป็น useCallback เพื่อลด re-render ลูก
- [x] ห่อ Main1_Photos ด้วย React.memo และอัปโหลดจริงพร้อมพรีวิว URL ระยะไกล

1.2 ข้อมูลทั่วไป/ผัง-แผนที่
- [x] AddressPermitSection แบบ React.memo + local state + commit onBlur (ลด setState ขึ้น parent ทุกคีย์)
- [ ] MapLayoutSection แยกเป็นคอมโพเนนต์ memoized (คุมพรีวิว/อัปโหลดแบบแยกส่วน)

1.3 รายละเอียดการตรวจ (การ์ด + ตาราง)
- [x] การ์ด 7 หัวข้อ: ช่อง “รายละเอียดเพิ่มเติม” และ “อื่น ๆ (ระบุ)” ใช้ local draft + commit onBlur
- [x] ตาราง 5 หมวด: ใช้ RemarkCell สำหรับ “หมายเหตุ”, ช่อง “อื่น ๆ (ระบุ)” commit onBlur และคง key คงที่

2.5 แผนความถี่ (ตาราง)
- [x] ยึดแถว “อื่น ๆ (ระบุ)” ตามตำแหน่ง ไม่อิงข้อความ (ป้องกันสลับ element ขณะพิมพ์)
- [ ] ทวน onChange เฉพาะจุดที่เป็นข้อความให้ใช้ onBlur/debounce หากยังมีอาการ

2.6 ผลการตรวจ (ตาราง)
- [ ] คงโครงสร้างแถวแบบคงที่, ใช้ RemarkCell อยู่แล้ว ทวนเฉพาะช่องที่ยัง onChange ต่อคีย์สโตรก

2.7 สรุป/ลงนาม (ตาราง/ฟอร์มลงนาม)
- [x] ช่องข้อความที่พิมพ์ยาว (หมายเหตุ/ชื่อ) ใช้ commit onBlur หรือ debounce ลดการอัปเดตขึ้น orchestrator ต่อคีย์สโตรก
- [x] ยืนยันว่า radio/select ไม่ทำให้ส่วนอื่น re-mount ระหว่างพิมพ์ข้อความ (ใช้ CheckTick + key คงที่)

ทดสอบ/ส่งมอบ (รันเมื่อข้างบนครบทีละข้อ)
- [ ] npx tsc --noEmit เฉพาะโค้ดที่แตะ + npm run build
- [ ] docker compose build app --no-cache
- [ ] docker compose up -d --force-recreate app
- [ ] ตรวจ /api/health = 200 และทดสอบพิมพ์/อัปโหลดบน 360/768/1280

[Progress Update — 2568-11-20]
- [x] 1.0: ช่องข้อความทุกช่องใช้ draft + onBlur (year, signTitle, companyName, companyAddress, legalBasisLine1/2, headerNote)
- [x] 1.1: scopeNote ใช้ draft + onBlur (ลดโอกาสหลุดโฟกัส)
- [x] 1.4: ส่วนลงนามทั้งหมดใช้ draft + onBlur (ผู้ตรวจ/วันที่/ผู้แทน/หมายเหตุ/ข้อแก้ไข)
- [x] 2.5: “อื่น ๆ (ระบุ)” ยึดตำแหน่งคงที่ และพิมพ์ต่อเนื่องได้ ไม่สลับ element


[Checklist: แก้อาการหน้าจอขยับเมื่อกด checkbox/radio — ครอบคลุม 1.3 / 1.4 / 2.5–2.7]
หลักการรวม:
- [x] ลดขอบเขตการอัปเดต: อัปเดตเฉพาะแถว/การ์ดที่เปลี่ยน (เริ่มทำใน 2.5/2.6), เลิก clone ชุดใหญ่ใน 2.5/2.6
- [ ] แยกคอมโพเนนต์ระดับแถว/การ์ด + ใช้ React.memo, handler ใช้ useCallback
- [x] คุมเลย์เอาต์ให้คงที่: ตั้ง min-height กล่องจดหมาย 1.4, ตารางใช้ table-fixed/h-10 (มีแล้ว)
- [x] ตัด scroll anchoring: ใส่ overflow-anchor:none ให้ Section wrapper
- [ ] คง key และชื่อกลุ่ม radio ให้คงที่/unique ต่อแถว (ทวนซ้ำหลัง refactor)

1.3 การ์ด (7 หัวข้อ)
- [ ] แยก CardItem เป็นคอมโพเนนต์ memo ต่อข้อ
- [ ] setItem อัปเดตเฉพาะ item.key, ไม่สร้าง items ทั้งก้อนใหม่
- [x] กันพื้นที่ “อื่น ๆ (ระบุ)” และ badge แสดง/ซ่อนด้วย min-height คงที่ (ไม่ทำให้เพจสั่น)

1.3 ตาราง (5 หมวด)
- [ ] แยก Row เป็นคอมโพเนนต์ memo ต่อแถว
- [x] “อื่น ๆ (ระบุ)” ใช้ draft + onBlur ครบทุกหมวด (คง key/name radio ให้คงที่)
- [x] “หมายเหตุ” ใช้ RemarkCell, ตรึงความสูง cell ให้คงที่

1.4 สรุปผล/จดหมาย/ลงนาม
- [x] Letter container: กำหนด min-h-* และ contain:layout + overflow-anchor:none เฉพาะกล่องจดหมาย (ลด reflow/jump)
- [ ] ป้าย/ริบบิ้ น ใช้ position:absolute และกันหัวเรื่องคงที่ (ทวนความสูงให้พอ)
- [x] อัปเดตเฉพาะกิ่งของ signoff/summary.rows[idx] (ไม่ set state ข้ามส่วน) — updateRow เป็น useCallback แล้ว
- [ ] ย้าย logic รวมสรุป (ถ้ามี setState ซ้อน) ไปเป็น useMemo/คำนวณระหว่าง render แทน useEffect ที่ push state

2.5 แผนความถี่
- [x] แยก Row เป็น memo, setRow อัปเดตเฉพาะแถว (เลิก JSON clone)
- [x] ตรวจซ้ำแถว “อื่น ๆ (ระบุ)” ให้ใช้ draft + onBlur พร้อม key/name คงที่ (ทำแล้ว แต่ทวนอีกครั้งหลังแยก Row)

2.6 ผลการตรวจ
- [x] แยก Row เป็น memo, setRow อัปเดตเฉพาะแถว (เลิก JSON clone)
- [ ] “หมายเหตุ” ใช้ RemarkCell; Defect dialog ไม่เปลี่ยนความสูงแถว (ตรึง h-10)
- [ ] ตรวจ key/name radio ต่อแถวให้คงที่

2.7 สรุป/ลงนาม
- [ ] เลิก useEffect ที่ push rows ย้อน → ใช้ useMemo รวมผลจาก 2.6 แทน
- [ ] คง key/handler คงที่, ช่องข้อความยาวใช้ draft + onBlur (ทำแล้ว, ทวนซ้ำหลัง refactor)

ทดสอบรับงาน
- [ ] กด checkbox/radio ติดต่อกันใน 1.3/1.4/2.5/2.6/2.7 หน้าจอไม่เลื่อน/ไม่สั่น (360/768/1280)
- [ ] ใช้เมาส์/คีย์บอร์ด (Space/Enter) กับ checkbox/radio แล้ว viewport ไม่ขยับ


[Checklist: Excel Export 8_1 (ตามแบบ 1_3) — 2568-11-20]
เป้าหมาย: เพิ่มปุ่ม Export “Defect” ใน 8_1 ที่สร้างไฟล์ Excel รูปแบบเดียวกับ 1_3 (rich text, รูป ≤ 2 ใบ, สไตล์หัวตารางเหมือนกัน)

-เฟส A — สำรวจ/ยืนยัน Mapping (อ่านอย่างเดียว)
- [x] อ่านโค้ด: Form8_1.tsx, Form8_3_Plan_2_6.tsx, Form8_3_Plan_2_7.tsx เพื่อตอกย้ำโครงสร้างข้อมูลใช้งานจริง
- [ ] ระบุจุดเก็บสถานะ 2.6 “ใช้ได้/ใช้ไม่ได้” และ 2.7 “สรุป/แก้ไขแล้ว/หมายเหตุ” ที่จะไป export
- [ ] ระบุแหล่งรูป: defect.photos และ row.photos (กำหนดกติกาเลือกรูปสูงสุด 2 ใบ/รายการ)
- [ ] ยืนยัน meta: ใช้ job_id ดึง branchName และ job_start_date ผ่าน API เช่น 1_3

เฟส B — เตรียม Helper ใช้ร่วม (อิง 1_3)
- [ ] สร้างไฟล์กลาง utils/excelShared.ts สำหรับ: buildItemsRichText, buildFixRichText, estimateRowHeightForText, loadImage/sniffImageExt, pxToEMU/pxToPt
- [ ] เพิ่ม collectPhotos() ที่รวมทั้ง defect.photos และ row.photos พร้อมเติม src จาก filename ผ่าน NEXT_PUBLIC_N8N_UPLOAD_FILE เมื่อจำเป็น

เฟส C — ตัวส่งออกของ 8_1
- [x] สร้าง src/utils/exportToExcelForm8_1.ts ด้วยฟังก์ชัน exportToExcelForm8_1(section, id, jobId)
- [ ] ดึง meta ผ่าน API: branchName, jobById (ตามแบบ 1_3) และ master defect (ถ้าต้องเทียบข้อความ)
- [ ] เลือกเฉพาะแถว 2.6 ที่ “ใช้ไม่ได้” สำหรับรายการ export และใช้ 2.7 เพื่อยืนยันสรุปผล/หมายเหตุ
- [ ] สร้างคอลัมน์ Excel: No. (running 1..n), ชื่อสโตร์, ประเภท, รายการ, รูปก่อนปรับปรุง, สิ่งที่ต้องแก้ไข, วันที่เข้างาน
- [ ] ใช้ rich text ตามแพทเทิร์น 1_3 และจัดความสูงแถวอัตโนมัติ
- [ ] กันซ้ำรายการด้วยคีย์ที่เหมาะสม (เช่น ชื่อรายการ+กลุ่ม หรือ defect_no)

เฟส D — ผูกปุ่มหน้า 8_1
- [x] เพิ่มปุ่ม “Defect” ใน Form8_1.tsx ให้เรียก exportToExcelForm8_1(section, id, jobId)
- [ ] ตรวจพารามิเตอร์/ข้อมูลที่ส่งเข้าให้ครบ (id, jobId, section)

เฟส E — ทดสอบและตรวจรับ
- [ ] ทดสอบเคส: ไม่มี defect, มี defect แต่ไม่มีรูป, มีรูปครบ 2 ใบ, หลายรายการ “ใช้ไม่ได้” พร้อมกัน
- [ ] เปิดไฟล์ Excel ตรวจ rich text/หัวตาราง/ความสูงแถว/การวางรูป
- [ ] บันทึก Log: Investigate/Edit/NextToDo และติ๊ก checklist แต่ละข้อทันทีเมื่อเสร็จ

[อัปเดตเฉพาะ Form8_1 — อัปโหลด Defect]
- [x] DefectPopup: เก็บ src ชั่วคราวพร้อม filename และพยายาม upload ทันที แต่ไม่ block ถ้าล้มเหลว (บนเดสก์ท็อป)
- [x] Form8_1.tsx: เพิ่ม pre-save pass อัปโหลดรูป defect (blob:/data:) ด้วย uploadIfNeeded แล้ว clean เหลือ { filename } ก่อนส่งบันทึก
- [ ] ทดสอบจริง: เพิ่มรูปใน Defect (2.6) อย่างน้อย 1 รูป/รายการ → Save → ตรวจใน DB ว่ามี photos.filename → Export Excel ต้องเห็นรูป
- [x] Form8_3_Report_1_2: อัปโหลด map/layout ทันทีหลังเลือก และ clean ตอนบันทึก
- [x] Main1_Photos: อัปโหลด cover/signMain/setA/setB ทันทีหลังเลือก และ clean ตอนบันทึก
- [x] Form8_3_Report_1_0: อัปโหลดรูปปกทันทีหลังเลือก + ใช้ filename เก็บลงฟอร์ม (preview เป็น URL ระยะไกลเมื่อสำเร็จ)

# เฟส DefectPopup/2.6/2.7 (เพิ่ม  '+$ts+')
- [ ] ปรับ DefectPopup โชว์มินิมอลก่อน (เลือกหลายปัญหา/อื่นๆ) แล้วค่อยขยายรายละเอียด
- [ ] จำกัดรูป defect ≤ 2 และแสดงผลหลังอัปโหลด
- [ ] หัวตาราง 2.6: รอบที่ 1 + ใช้ได้/ใช้ไม่ได้ + Defect + หมายเหตุ
- [ ] หัวตาราง 2.7: รอบที่ 1 + ใช้ได้/ใช้ไม่ได้ + แก้ไขแล้ว + หมายเหตุ
- [ ] forms/get ดึงรายการล่าสุด (ORDER BY updated_date DESC, id DESC)
- [ ] ตรวจ JSON ว่ามี defects[].photos[{filename}] ครบหลังบันทึก

---------------------------------------------
[Checklist เพิ่มเติม – DefectPopup 8_1]
- [x] กัน popup ปิดเองเมื่อคลิก dropdown/checkbox/button (trap events + overlay close เฉพาะ overlay)
- [x] ย้าย react-select menuPortalTarget ไปยัง container ภายใน popup
- [x] ตั้ง closeMenuOnSelect=false สำหรับตัวเลือกหลายค่า (isMulti)
- [x] ปุ่มบันทึก type="button"
- [ ] ทดสอบจริงบนหน้า (เลือก/เพิ่ม/ลบ/อัปโหลด ≤2/คลิก overlay ปิด)


